@using System.Web
@using THECinema.Common
@model THECinema.Web.ViewModels.Movies.FullInfoMovieViewModel
@{
    ViewData["Title"] = "Details";

    var url = Model.TrailerVideoUrl;
    var uri = new Uri(url);
    var query = HttpUtility.ParseQueryString(uri.Query);
    var videoId = query["v"];
}
<link href="~/css/details.css" rel="stylesheet" asp-append-version="true" />
<link href="~/lib/fontawesome/css/all.css" rel="stylesheet" asp-append-version="true" />

<h1 class="text-center">@Model.Name</h1>

<div class="clearfix">
    <div class="box" id="imgBox">
        <img class="float-left" src="@Model.TrailerUrl" />
    </div>
    <div class="box" id="middleBox">
        <h5>Director</h5>
        <h7>@Model.Director</h7>
        <h5>Actors</h5>
        <h7>@Model.Actors</h7>
        <h5>Resume</h5>
        <p>@Model.Description</p>
        <h5>IMDb Rating</h5>
        <p>@Model.Rating</p>
    </div>
    <div class="box">
        <h5>Duration</h5>
        <h7>@Model.Duration minutes</h7>
        <h5>Year</h5>
        <h7>@Model.Year</h7>
        <h5>Genre</h5>
        <h7>@Model.Genre</h7>
        <hr />
        <a href="#" onclick="ShowForm('trailer')" class="btn btn-warning">WATCH TRAILER</a>
        <a href="/Projections/GetById?filmId=@Model.Id" id="bookBtn" class="btn btn-success">BOOK TICKET</a>
        <hr />
        @if (this.User.Identity.IsAuthenticated)
        {
            <a href="#" onclick="ShowForm('writeReviewForm')" class="btn btn-outline-secondary">WRITE REVIEW</a>
        }
    </div>
</div>

<div id="trailer">
    <iframe width="960" height="480"
            src="https://www.youtube.com/embed/@videoId">
    </iframe>
</div>

<h2 class="text-center">Reviews</h2>

@if (!Model.Reviews.Any())
{
    <h5 align="center">There are still no reviews for this movie.</h5>
    @if (this.User.Identity.IsAuthenticated)
    {
        <a align="center" href="#" onclick="ShowForm('writeReviewForm')"><h5>Be the first one to write a review!</h5></a>
    }
}

<div>
    <form asp-controller="Reviews" asp-action="Add" method="post" id="writeReviewForm" style="display: none">

        <div class="stars form-group">
            <input type="radio" id="star5" name="Stars" value="5" />
            <label for="star5" title="5 stars"></label>
            <input type="radio" id="star4" name="Stars" value="4" />
            <label for="star4" title="4 stars"></label>
            <input type="radio" id="star3" name="Stars" value="3" />
            <label for="star3" title="3 stars"></label>
            <input type="radio" id="star2" name="Stars" value="2" />
            <label for="star2" title="2 stars"></label>
            <input type="radio" id="star1" name="Stars" value="1" />
            <label for="star1" title="1 star"></label>
        </div>

        <div class="form-group">
            <label for="Title">Title</label>
            <input Name="Title" class="form-control" />
        </div>
        <div class="form-group">
            <label for="Content">Content</label>
            <textarea name="Content" class="form-control"></textarea>
        </div>
        <hr />
        <input type="hidden" name="MovieId" value="@Model.Id" />
        <div>
            <input type="submit" class="btn btn-success" value="Add Review" />
        </div>
    </form>
</div>

<hr />

@foreach (var review in Model.Reviews)
{
    <div>
        <form asp-controller="Reviews" asp-action="Edit" method="post" id="@review.Id" class="editReviewForm" style="display: none">

            <div class="form-group">
                <label for="Title">Title</label>
                <input Name="Title" class="form-control" value="@review.Title" />
            </div>
            <div class="form-group">
                <label for="Content">Content</label>
                <textarea name="Content" class="form-control">@Html.Raw(review.CleanContent)</textarea>
            </div>
            <hr />
            <input type="hidden" name="MovieId" value="@Model.Id" />
            <input type="hidden" name="Id" value="@review.Id" />
            <div>
                <input type="submit" class="btn btn-success" value="Edit Review" />
            </div>
            <hr />
        </form>
    </div>

    @if (review.Stars == 0)
    {
        review.Stars = 1;
    }

    <div class="card">
        <div class="card-header">
            Created by:
            <strong>@review.ApplicationUserUserName</strong>
            On
            <time datetime="@review.CreatedOn.ToString("O")"></time>
            <div class="float-right">
                @for (int i = 0; i < 5; i++)
                {
                    if (review.Stars > 0)
                    {
                        <span class="fa fa-star checked"></span>
                        review.Stars--;
                    }
                    else
                    {
                        <span class="fa fa-star"></span>
                    }
                }
            </div>
        </div>
        <div class="card-body">
            <h5 class="card-title">@review.Title</h5>
            <p class="card-text">@Html.Raw(review.CleanContent)</p>
            @if (this.User.Identity.IsAuthenticated)
            {
                @if (this.User.IsInRole(GlobalConstants.AdministratorRoleName))
                {
                    <a href="/Reviews/Delete?id=@review.Id&movieId=@Model.Id" class="btn btn-outline-danger float-right ml-1">Detele</a>
                }

                @if (this.User.Identity.Name == review.ApplicationUserUserName)
                {
                    <a href="#" onclick="ShowForm(@review.Id)" class="btn btn-outline-warning editReviewBtn float-right ml-1">Edit</a>
                }
                <a href="#" onclick="ShowForm('writeCommentForm')" class="btn btn-outline-success float-right">Comment</a>
            }
        </div>
    </div>

    foreach (var comment in review.Comments)
    {
        <div>
            <form asp-controller="Comments" asp-action="Edit" method="post" id="@comment.Id" class="editCommentForm" style="display: none">
                <div class="form-group">
                    <label for="Content">Content</label>
                    <textarea name="Content" class="form-control">@Html.Raw(comment.CleanContent)</textarea>
                </div>
                <hr />
                <input type="hidden" name="MovieId" value="@Model.Id" />
                <input type="hidden" name="Id" value="@comment.Id" />
                <div>
                    <input type="submit" class="btn btn-success" value="Edit Comment" />
                </div>
                <hr />
            </form>
        </div>


        <div class="card custom-comment float-right">
            <div class="card-header">
                Created by:
                <strong>@comment.ApplicationUserUserName</strong>
                On
                <time datetime="@comment.CreatedOn.ToString("O")"></time>
            </div>
            <div class="card-body">
                <p class="card-text">@Html.Raw(comment.CleanContent)</p>
                @if (this.User.Identity.IsAuthenticated)
                {
                    @if (this.User.IsInRole(GlobalConstants.AdministratorRoleName))
                    {
                        <a href="/Comments/Delete?id=@comment.Id&movieId=@Model.Id" class="btn btn-outline-danger float-right ml-1">Detele</a>
                    }

                    @if (this.User.Identity.Name == comment.ApplicationUserUserName)
                    {
                        <a href="#" onclick="ShowForm(@comment.Id)" class="btn btn-outline-warning editReviewBtn float-right ml-1">Edit</a>
                    }
                }
            </div>
        </div>
        <div class="clearfix"></div>
    }

    <div>
        <form asp-controller="Comments" asp-action="Add" method="post" id="writeCommentForm" style="display: none">
            <div class="form-group">
                <label for="Content">Content</label>
                <textarea name="Content" class="form-control"></textarea>
            </div>
            <hr />
            <input type="hidden" name="MovieId" value="@Model.Id" />
            <input type="hidden" name="ReviewId" value="@review.Id" />
            <div>
                <input type="submit" class="btn btn-success" value="Add Comment" />
            </div>
        </form>
    </div>

}

<script src="~/lib/jquery/dist/jquery.js"></script>
<script src="/lib/tinymce/tinymce.min.js" type="text/javascript"></script>

<script type="text/javascript">
    tinymce.init({
        selector: "textarea",
        plugins: ["image paste table link code media"]
    });

    function ShowForm(id) {
        $("#" + id).show();
        $('html, body').animate({
            scrollTop: $("#" + id).offset().top
        }, 500);
    }
</script>
